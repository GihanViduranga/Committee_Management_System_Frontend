<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MeetHive Login</title>
    <link rel="icon" href="resources/images/LogoBGRemove.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <style>
        body {
            background-color: #121212;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            color: #ffffff;
        }
        .login-image {
            background-image: url('resources/LoginImage.jpg');
            background-size: cover;
            background-position: center;
        }

        .card {
            margin-top: -32px;
            overflow: hidden;
            height: auto;
            max-height: 750px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
            background-color: #1e1e1e;
            border: none;
        }
        .card-body {
            margin-bottom: 50px;
            overflow-y: auto;
            max-height: 100%;
            padding: 1.5rem;
        }

        .text-center img {
            width: 185px;
        }
        .btn-block {
            margin-top: -20px;
            width: 100%;
            background: #ff6f00;
            color: white;
            border: none;
        }
        .btn-block:hover {
            background: #ff8f40;
        }
        .btn-outline-success {
            border-color: #ff6f00;
            color: #ff6f00;
        }
        .btn-outline-success:hover {
            background: #ff6f00;
            color: white;
        }

        /* Forgot Password Modal Styles */
        .modal-content {
            background-color: #1e1e1e;
            color: #ffffff;
            border-radius: 10px;
        }
        .modal-header {
            border-bottom: 1px solid #2d2d2d;
        }
        .modal-footer {
            border-top: 1px solid #2d2d2d;
        }
        .form-control {
            background-color: #2d2d2d;
            border: 1px solid #3d3d3d;
            color: #ffffff;
        }
        .form-control:focus {
            background-color: #2d2d2d;
            border-color: #ff6f00;
            box-shadow: 0 0 0 0.25rem rgba(255, 111, 0, 0.25);
            color: #ffffff;
        }
        .btn-primary {
            background-color: #ff6f00;
            border-color: #ff6f00;
        }
        .btn-primary:hover {
            background-color: #ff8f40;
            border-color: #ff8f40;
        }
        .btn-secondary {
            background-color: #3d3d3d;
            border-color: #3d3d3d;
        }
        .btn-secondary:hover {
            background-color: #4d4d4d;
            border-color: #4d4d4d;
        }
        .modal-title {
            color: #ff6f00;
        }
    </style>
</head>
<body>
<section class="h-100">
    <div class="container py-5 h-100">
        <div class="row d-flex justify-content-center align-items-center h-100">
            <div class="col-xl-10">
                <div class="card rounded-3 text-white">
                    <div class="row g-0">
                        <div class="col-lg-6 login-image"></div>
                        <div class="col-lg-6">
                            <div class="card-body p-md-5 mx-md-4">
                                <div class="text-center">
                                    <img src="resources/images/Logo.jpg" alt="logo">
                                    <h4 class="mt-1 mb-5 pb-1">The MeetHive Committee</h4>
                                </div>
                                <form>
                                    <p>Please log in to your account</p>
                                    <div class="form-outline mb-4">
                                        <input type="email" id="email" class="form-control" placeholder="Phone number or email address" />
                                        <label class="form-label" for="email">Username</label>
                                    </div>
                                    <div class="form-outline mb-4">
                                        <input type="password" id="password" class="form-control" placeholder="Enter Your Password"/>
                                        <label class="form-label" for="password">Password</label>
                                    </div>
                                    <div class="text-center pt-1 mb-5 pb-1">
                                        <button id="LoginBtn" class="btn btn-block fa-lg mb-3" type="submit">Log in</button><br>
                                        <a href="#" id="forgotPasswordLink">Forgot password?</a>
                                    </div>
                                    <div class="d-flex align-items-center justify-content-center pb-4">
                                        <p class="mb-0 me-2">Don't have an account?</p>
                                        <a href="registration.html">Create account</a>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Forgot Password Modal -->
<div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-labelledby="forgotPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="forgotPasswordModalLabel">Reset Password</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="emailStep">
                    <p>Enter your email to receive a one-time password (OTP)</p>
                    <div class="mb-3">
                        <label for="resetEmail" class="form-label">Email address</label>
                        <input type="email" class="form-control" id="resetEmail" placeholder="name@example.com">
                    </div>
                    <div class="d-grid">
                        <button class="btn btn-primary" id="sendOtpBtn">Send OTP</button>
                    </div>
                </div>

                <div id="otpStep" style="display: none;">
                    <p>Enter the OTP sent to your email and create a new password</p>
                    <div class="mb-3">
                        <label for="otpCode" class="form-label">OTP Code</label>
                        <input type="text" class="form-control" id="otpCode" placeholder="Enter 6-digit OTP">
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword" placeholder="Create new password">
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm new password">
                    </div>
                    <div class="d-grid">
                        <button class="btn btn-primary" id="resetPasswordBtn">Reset Password</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!--<script src="js/controller/login.js"></script>-->

<script>
    document.getElementById("LoginBtn").addEventListener("click", function (event) {
        event.preventDefault();

        let email = document.getElementById("email").value.trim();
        let password = document.getElementById("password").value.trim();

        if (!email || !password) {
            Swal.fire({
                icon: "error",
                title: "Oops...",
                text: "Please enter both email and password."
            });
            return;
        }

        let user = { email, password };

        fetch("http://localhost:8080/api/v1/auth/authenticate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(user)
        })
            .then(response => response.json())
            .then(response => {
                if (response.code === 201 && response.data.token) {
                    localStorage.setItem("authToken", response.data.token);

                    fetch("http://localhost:8080/api/v1/admin/checkRole", {
                        method: "GET",
                        headers: { "Authorization": `Bearer ${response.data.token}` }
                    })
                        .then(response => response.json())
                        .then(userData => {
                            console.log("User Data:", userData.isActive);

                            // First check if user is active
                            if (!userData.isActive) {
                                Swal.fire({
                                    icon: "error",
                                    title: "Account Inactive",
                                    text: "Your account is not active. Please contact an administrator."
                                });
                                localStorage.removeItem("authToken"); // Clear invalid token
                                return;
                            }

                            // Then check role for redirection
                            switch (userData.role) {
                                case "NEW_USER":
                                    window.location.href = "index.html";
                                    Swal.fire("Login Success!", "", "success");
                                    break;
                                case "ADMIN":
                                    window.location.href = "adminDashboard.html";
                                    Swal.fire("Login Success!", "", "success");
                                    break;
                                case "USER":
                                    window.location.href = "memberDashboard.html";
                                    Swal.fire("Login Success!", "", "success");
                                    break;
                                default:
                                    Swal.fire({
                                        icon: "error",
                                        title: "Access Denied",
                                        text: "You don't have permission to access this system."
                                    });
                                    localStorage.removeItem("authToken");
                            }
                        })
                        .catch(error => {
                            console.error("Error checking role/status:", error);
                            Swal.fire({
                                icon: "error",
                                title: "Error",
                                text: "Failed to verify your account status."
                            });
                        });
                } else {
                    Swal.fire({
                        icon: "error",
                        title: "Login Failed",
                        text: response.message || "Invalid email or password."
                    });
                }
            })
            .catch(error => {
                console.error("Login error:", error);
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: "An error occurred during login. Please try again."
                });
            });
    });
                // Forgot Password Functionality
                const forgotPasswordModal = new bootstrap.Modal(document.getElementById('forgotPasswordModal'));

                // Show modal when "Forgot password?" link is clicked
                document.getElementById('forgotPasswordLink').addEventListener('click', function (e) {
                    e.preventDefault();
                    // Reset the form
                    document.getElementById('resetEmail').value = '';
                    document.getElementById('otpCode').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';

                    // Show email step, hide OTP step
                    document.getElementById('emailStep').style.display = 'block';
                    document.getElementById('otpStep').style.display = 'none';

                    forgotPasswordModal.show();
                });

                // Send OTP button click handler
                document.getElementById('sendOtpBtn').addEventListener('click', function () {
                    const email = document.getElementById('resetEmail').value.trim();

                    if (!email) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Please enter your email address'
                        });
                        return;
                    }

                    // Show loading state
                    Swal.fire({
                        title: 'Sending OTP...',
                        didOpen: () => {
                            Swal.showLoading();
                        },
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: false
                    });

                    // Send request to backend
                    fetch('http://localhost:8080/api/v1/auth/send-otp', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({email: email})
                    })
                        .then(response => response.json())
                        .then(data => {
                            Swal.close();

                            if (data.message === 'OTP sent.') {
                                // Switch to OTP verification step
                                document.getElementById('emailStep').style.display = 'none';
                                document.getElementById('otpStep').style.display = 'block';

                                Swal.fire({
                                    icon: 'success',
                                    title: 'OTP Sent',
                                    text: 'Please check your email for the OTP code',
                                    timer: 3000,
                                    timerProgressBar: true
                                });
                            } else {
                                throw new Error(data.message || 'Failed to send OTP');
                            }
                        })
                        .catch(error => {
                            console.error('Error sending OTP:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'OTP Error',
                                text: 'Failed to send OTP. Please try again later.'
                            });
                        });
                });

                // Reset Password button click handler
                document.getElementById('resetPasswordBtn').addEventListener('click', function () {
                    const email = document.getElementById('resetEmail').value.trim();
                    const otp = document.getElementById('otpCode').value.trim();
                    const newPassword = document.getElementById('newPassword').value.trim();
                    const confirmPassword = document.getElementById('confirmPassword').value.trim();

                    // Validate inputs
                    if (!otp || !newPassword || !confirmPassword) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Please fill in all fields'
                        });
                        return;
                    }

                    if (newPassword !== confirmPassword) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Passwords do not match'
                        });
                        return;
                    }

                    // Show loading state
                    Swal.fire({
                        title: 'Resetting Password...',
                        didOpen: () => {
                            Swal.showLoading();
                        },
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: false
                    });

                    // Send request to verify OTP and update password
                    fetch('http://localhost:8080/api/v1/auth/verify-otp', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            email: email,
                            otp: otp,
                            newPassword: newPassword
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            Swal.close();

                            if (data.message === 'Password updated.') {
                                // Close modal
                                forgotPasswordModal.hide();

                                // Show success message
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success!',
                                    text: 'Your password has been reset successfully',
                                    confirmButtonColor: '#ff6f00'
                                });
                            } else {
                                throw new Error(data.message || 'Failed to reset password');
                            }
                        })
                        .catch(error => {
                            console.error('Error resetting password:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Invalid OTP or the OTP has expired. Please try again.'
                            });
                        });
            });
</script>
<script src="js/jquery-3.7.1.min.js"></script>
</body>
</html>